<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CoolybotLoggingMetricsExportConfiguration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coolybot server-side framework</a> &gt; <a href="index.source.html" class="el_package">io.github.coolys.config.metric</a> &gt; <span class="el_source">CoolybotLoggingMetricsExportConfiguration.java</span></div><h1>CoolybotLoggingMetricsExportConfiguration.java</h1><pre class="source lang-java linenums">package io.github.coolys.config.metric;

import com.codahale.metrics.MetricRegistry;
import com.codahale.metrics.Slf4jReporter;
import io.github.coolys.config.CoolybotProperties;
import io.micrometer.core.instrument.Clock;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.dropwizard.DropwizardConfig;
import io.micrometer.core.instrument.dropwizard.DropwizardMeterRegistry;
import io.micrometer.core.instrument.util.HierarchicalNameMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.Marker;
import org.slf4j.MarkerFactory;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.concurrent.TimeUnit;

/**
 * Console Reporter Configuration
 *
 * Pass the metrics to the logs with Dropwizard Reporter implementation
 * see https://github.com/micrometer-metrics/micrometer-docs/blob/9fedeb5/src/docs/guide/console-reporter.adoc
 */
@Configuration
@ConditionalOnProperty(&quot;coolybot.metrics.logs.enabled&quot;)
public class CoolybotLoggingMetricsExportConfiguration {
<span class="nc" id="L30">    private final Logger log = LoggerFactory.getLogger(CoolybotLoggingMetricsExportConfiguration.class);</span>

    private final CoolybotProperties jHipsterProperties;

<span class="nc" id="L34">    public CoolybotLoggingMetricsExportConfiguration(CoolybotProperties jHipsterProperties) {</span>
<span class="nc" id="L35">        this.jHipsterProperties = jHipsterProperties;</span>
<span class="nc" id="L36">    }</span>

    @Bean
    public MetricRegistry dropwizardRegistry() {
<span class="nc" id="L40">        return new MetricRegistry();</span>
    }

    @Bean
    public Slf4jReporter consoleReporter(MetricRegistry dropwizardRegistry) {
<span class="nc" id="L45">        log.info(&quot;Initializing Metrics Log reporting&quot;);</span>
<span class="nc" id="L46">        Marker metricsMarker = MarkerFactory.getMarker(&quot;metrics&quot;);</span>
<span class="nc" id="L47">        final Slf4jReporter reporter = Slf4jReporter.forRegistry(dropwizardRegistry)</span>
<span class="nc" id="L48">            .outputTo(LoggerFactory.getLogger(&quot;metrics&quot;))</span>
<span class="nc" id="L49">            .markWith(metricsMarker)</span>
<span class="nc" id="L50">            .convertRatesTo(TimeUnit.SECONDS)</span>
<span class="nc" id="L51">            .convertDurationsTo(TimeUnit.MILLISECONDS)</span>
<span class="nc" id="L52">            .build();</span>
<span class="nc" id="L53">        reporter.start(jHipsterProperties.getMetrics().getLogs().getReportFrequency(), TimeUnit.SECONDS);</span>
<span class="nc" id="L54">        return reporter;</span>
    }

    // Needed to enable the Console reporter
    // https://github.com/micrometer-metrics/micrometer-docs/blob/9fedeb5/src/docs/guide/console-reporter.adoc
    @Bean
    public MeterRegistry consoleLoggingRegistry(MetricRegistry dropwizardRegistry) {
<span class="nc" id="L61">        DropwizardConfig dropwizardConfig = new DropwizardConfig() {</span>
            @Override
            public String prefix() {
<span class="nc" id="L64">                return &quot;console&quot;;</span>
            }

            @Override
            public String get(String key) {
<span class="nc" id="L69">                return null;</span>
            }
        };

<span class="nc" id="L73">        return new DropwizardMeterRegistry(dropwizardConfig, dropwizardRegistry, HierarchicalNameMapper.DEFAULT, Clock.SYSTEM) {</span>
            @Override
            protected Double nullGaugeValue() {
<span class="nc" id="L76">                return null;</span>
            }
        };
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>