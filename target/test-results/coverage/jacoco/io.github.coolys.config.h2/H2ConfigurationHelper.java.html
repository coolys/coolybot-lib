<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>H2ConfigurationHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coolybot server-side framework</a> &gt; <a href="index.source.html" class="el_package">io.github.coolys.config.h2</a> &gt; <span class="el_source">H2ConfigurationHelper.java</span></div><h1>H2ConfigurationHelper.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2016-2019 the original author or authors from the Coolybot project.
 *
 * This file is part of the Coolybot project, see https://www.coolybot.tech/
 * for more information.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package io.github.coolys.config.h2;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.sql.SQLException;
import javax.servlet.*;

/**
 * Utility class to configure H2 in development.
 *
 * We don't want to include H2 when we are packaging for the &quot;prod&quot; profile and won't
 * actually need it, so we have to load / invoke things at runtime through reflection.
 */
<span class="nc" id="L33">public class H2ConfigurationHelper {</span>

    public static Object createServer() throws SQLException {
<span class="nc" id="L36">        return createServer(&quot;9092&quot;);</span>
    }

    public static Object createServer(String port) throws SQLException {
        try {
<span class="nc" id="L41">            ClassLoader loader = Thread.currentThread().getContextClassLoader();</span>
<span class="nc" id="L42">            Class&lt;?&gt; serverClass = Class.forName(&quot;org.h2.tools.Server&quot;, true, loader);</span>
<span class="nc" id="L43">            Method createServer = serverClass.getMethod(&quot;createTcpServer&quot;, String[].class);</span>
<span class="nc" id="L44">            return createServer.invoke(null, new Object[] { new String[] { &quot;-tcp&quot;,&quot;-tcpAllowOthers&quot;, &quot;-tcpPort&quot;, port } });</span>

<span class="nc" id="L46">        } catch (ClassNotFoundException | LinkageError e) {</span>
<span class="nc" id="L47">            throw new RuntimeException(&quot;Failed to load and initialize org.h2.tools.Server&quot;, e);</span>

<span class="nc" id="L49">        } catch (SecurityException | NoSuchMethodException e) {</span>
<span class="nc" id="L50">            throw new RuntimeException(&quot;Failed to get method org.h2.tools.Server.createTcpServer()&quot;, e);</span>

<span class="nc" id="L52">        } catch (IllegalAccessException | IllegalArgumentException e) {</span>
<span class="nc" id="L53">            throw new RuntimeException(&quot;Failed to invoke org.h2.tools.Server.createTcpServer()&quot;, e);</span>

<span class="nc" id="L55">        } catch (InvocationTargetException e) {</span>
<span class="nc" id="L56">            Throwable t = e.getTargetException();</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">            if (t instanceof SQLException) {</span>
<span class="nc" id="L58">                throw (SQLException) t;</span>
            }
<span class="nc" id="L60">            throw new RuntimeException(&quot;Unchecked exception in org.h2.tools.Server.createTcpServer()&quot;, t);</span>
        }
    }

    public static void initH2Console(ServletContext servletContext) {
        try {
            // We don't want to include H2 when we are packaging for the &quot;prod&quot; profile and won't
            // actually need it, so we have to load / invoke things at runtime through reflection.
<span class="nc" id="L68">            ClassLoader loader = Thread.currentThread().getContextClassLoader();</span>
<span class="nc" id="L69">            Class&lt;?&gt; servletClass = Class.forName(&quot;org.h2.server.web.WebServlet&quot;, true, loader);</span>
<span class="nc" id="L70">            Servlet servlet = (Servlet) servletClass.newInstance();</span>

<span class="nc" id="L72">            ServletRegistration.Dynamic h2ConsoleServlet = servletContext.addServlet(&quot;H2Console&quot;, servlet);</span>
<span class="nc" id="L73">            h2ConsoleServlet.addMapping(&quot;/h2-console/*&quot;);</span>
<span class="nc" id="L74">            h2ConsoleServlet.setInitParameter(&quot;-properties&quot;, &quot;src/main/resources/&quot;);</span>
<span class="nc" id="L75">            h2ConsoleServlet.setLoadOnStartup(1);</span>

<span class="nc" id="L77">        } catch (ClassNotFoundException | LinkageError e) {</span>
<span class="nc" id="L78">            throw new RuntimeException(&quot;Failed to load and initialize org.h2.server.web.WebServlet&quot;, e);</span>

<span class="nc" id="L80">        } catch (IllegalAccessException | InstantiationException e) {</span>
<span class="nc" id="L81">            throw new RuntimeException(&quot;Failed to instantiate org.h2.server.web.WebServlet&quot;, e);</span>
<span class="nc" id="L82">        }</span>
<span class="nc" id="L83">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>